<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมออกแบบเมือง Vectoria</title>
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <!-- โหลดและตั้งค่า MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    // Typeset หน้าที่แสดงผลครั้งแรก
                    if (document.getElementById('game-content')) {
                        MathJax.typesetPromise([document.getElementById('game-content')]);
                    }
                }
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        /* ใช้ฟอนต์ Sarabun */
        body {
            font-family: 'Sarabun', sans-serif;
        }
        
        /* สไตล์สำหรับ input */
        .game-input {
            @apply border border-gray-300 rounded-md p-2 text-center transition-all duration-200;
        }
        .game-input:focus {
            @apply border-indigo-500 ring-2 ring-indigo-200 outline-none;
        }
        /* สไตล์สำหรับปุ่ม */
        .game-button {
            @apply bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5;
        }
        /* สไตล์สำหรับข้อความ feedback */
        .feedback {
            @apply h-6 mt-2 text-sm font-semibold;
        }
        .feedback.correct {
            color: #16a34a; /* green-600 */
        }
        .feedback.incorrect {
            color: #dc2626; /* red-600 */
        }
        .task-card {
            @apply bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm mb-3 transition-all duration-200 hover:shadow-md hover:border-gray-300;
        }
        .task-card.completed {
            @apply bg-green-50 border-green-200;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <!-- [EDIT] เปลี่ยน max-w-6xl เป็น max-w-7xl -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        <header class="p-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
            <h1 class="text-3xl font-bold text-center">เกมออกแบบเมือง Vectoria</h1>
            <p class="text-center text-gray-200 mt-1">จงวางผังเมืองและสร้างถนนโดยใช้ความรู้เรื่องเวกเตอร์!</p>
        </header>
        
        <!-- เนื้อหาเกมออกแบบเมือง -->
        <div id="game-content" class="p-4 md:p-8">
            <!-- [EDIT] เปลี่ยนจาก flex-col เป็น md:flex-row -->
            <div class="flex flex-col md:flex-row gap-8">
                
                <!-- ส่วนของแผนที่ (ย้ายมาไว้ข้างบน) -->
                <!-- [EDIT] ปรับสัดส่วน md:w-3/5 -->
                <div class="flex flex-col items-center w-full md:w-3/5">
                    <h3 class="text-xl font-semibold text-center mb-2">แผนผังเมือง Vectoria</h3>
                    <!-- [EDIT] ขยายขนาด Canvas เป็น 700x500 -->
                    <canvas id="canvas" width="700" height="500" class="border-2 border-gray-400 bg-slate-50 rounded-lg shadow-md"></canvas>
                </div>

                <!-- ส่วนของโจทย์ (ย้ายมาไว้ข้างล่าง) -->
                <!-- [EDIT] ปรับสัดส่วน md:w-2/5 และเพิ่ม md:max-h-[500px] md:overflow-y-auto -->
                <div class="flex-1 md:w-2/5 md:max-h-[500px] md:overflow-y-auto md:pr-4">
                    
                    <!-- Progress Bar (ใหม่) -->
                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">ความคืบหน้าภารกิจ</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                            <div id="progress-bar" class="h-4 bg-gradient-to-r from-green-400 to-blue-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- เฟส 1: วางตำแหน่ง -->
                    <h2 class="text-2xl font-bold mb-3 text-indigo-700 flex items-center gap-2">
                        <!-- ไอคอน MapPin -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M20 10c0 6-8 12-8 12S4 16 4 10a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        เฟส 1: วางตำแหน่งสิ่งก่อสร้าง
                    </h2>
                    <p class="mb-4 text-gray-700">จงวางตำแหน่งสิ่งก่อสร้างหลัก 3 แห่งนี้ให้ถูกต้องก่อนเริ่มสร้างถนน</p>
                    
                    <div class="space-y-3 mb-8">
                        <!-- ภารกิจ 1 -->
                        <div id="task1-card" class="task-card">
                            <p class="font-semibold">ภารกิจ 1: สร้าง 'ศาลากลาง' (H) ที่พิกัด (1, 2)</p>
                            <div class="mt-2 flex items-center gap-3">
                                ( <input type="number" id="t1-x" class="game-input w-20" value="1"> , 
                                <input type="number" id="t1-y" class="game-input w-20" value="2"> )
                                <button class="game-button" onclick="checkTask(1)">สร้าง</button>
                            </div>
                            <p id="feedback-t1" class="feedback"></p>
                        </div>

                        <!-- ภารกิจ 2 -->
                        <div id="task2-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 2: สร้าง 'โรงเรียน' (S) โดยมีเวกเตอร์ตำแหน่ง $\vec{OS} = -3\vec{i} + 5\vec{j}$ จงระบุพิกัด</p>
                            <div class="mt-2 flex items-center gap-3">
                                ( <input type="number" id="t2-x" class="game-input w-20" placeholder="X"> , 
                                <input type="number" id="t2-y" class="game-input w-20" placeholder="Y"> )
                                <button class="game-button" onclick="checkTask(2)">สร้าง</button>
                            </div>
                            <p id="feedback-t2" class="feedback"></p>
                        </div>

                        <!-- ภารกิจ 3 (ปรับใหม่) -->
                        <div id="task3-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 3: สร้าง 'โรงพยาบาล' (P) โดยที่เวกเตอร์จากโรงเรียน (S) ไปยังโรงพยาบาล ( $\vec{SP}$ ) คือ $\vec{v} = 7\vec{i} + 1\vec{j}$ จงหาพิกัดของ P</p>
                            <div class="mt-2 flex items-center gap-3">
                                ( <input type="number" id="t3-x" class="game-input w-20" placeholder="X"> , 
                                <input type="number" id="t3-y" class="game-input w-20" placeholder="Y"> )
                                <button class="game-button" onclick="checkTask(3)">สร้าง</button>
                            </div>
                            <p id="feedback-t3" class="feedback"></p>
                        </div>
                    </div>

                    <!-- เฟส 2: สร้างถนน -->
                    <!-- [EDIT] เพิ่ม id และ class hidden -->
                    <h2 id="phase2-heading" class="text-2xl font-bold mb-3 text-indigo-700 flex items-center gap-2 hidden">
                        <!-- ไอคอน Road -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-road"><path d="M4 19.5v-15a2.5 2.5 0 0 1 2.5-2.5h11A2.5 2.5 0 0 1 20 4.5v15"/><path d="M12 10h.01"/><path d="M12 6h.01"/><path d="M12 14h.01"/><path d="M12 18h.01"/></svg>
                        เฟส 2: สร้างถนนเชื่อมเมือง
                    </h2>
                    <!-- [EDIT] เพิ่ม id และ class hidden -->
                    <p id="phase2-desc" class="mb-4 text-gray-700 hidden">เมื่อวางตำแหน่งเสร็จแล้ว มาเริ่มสร้างถนนกันต่อ!</p>
                    
                    <div class="space-y-3">
                        <!-- ภารกิจ 4 (ใหม่) -->
                        <div id="task4-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 4: ถนนจากศาลากลาง (H) ไปโรงพยาบาล (P) อธิบายด้วยเวกเตอร์ $\vec{HP}$ จงหา $\vec{HP} = a\vec{i} + b\vec{j}$</p>
                            <div class="mt-2 flex items-center gap-3">
                                $a=$ <input type="number" id="t4-x" class="game-input w-20" placeholder="a"> , 
                                $b=$ <input type="number" id="t4-y" class="game-input w-20" placeholder="b">
                                <button class="game-button" onclick="checkTask(4)">ตรวจสอบ</button>
                            </div>
                            <p id="feedback-t4" class="feedback"></p>
                        </div>
                        
                        <!-- ภารกิจ 5 (ใหม่) -->
                        <div id="task5-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 5: จงหาความยาวของถนน $\vec{HP}$ (หน่วย)</p>
                            <div class="mt-2 flex items-center gap-3">
                                <input type="number" id="t5-ans" class="game-input w-28" placeholder="ความยาว">
                                <button class="game-button" onclick="checkTask(5)">ตรวจสอบ</button>
                            </div>
                            <p id="feedback-t5" class="feedback"></p>
                        </div>

                        <!-- ภารกิจ 6 (ใหม่) -->
                        <div id="task6-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 6: ถนนจากโรงเรียน (S) ไปโรงพยาบาล (P) อธิบายด้วยเวกเตอร์ $\vec{SP}$ จงหา $\vec{SP} = a\vec{i} + b\vec{j}$</p>
                            <div class="mt-2 flex items-center gap-3">
                                $a=$ <input type="number" id="t6-x" class="game-input w-20" placeholder="a"> , 
                                $b=$ <input type="number" id="t6-y" class="game-input w-20" placeholder="b">
                                <button class="game-button" onclick="checkTask(6)">ตรวจสอบ</button>
                            </div>
                            <p id="feedback-t6" class="feedback"></p>
                        </div>

                        <!-- ภารกิจ 7 (ใหม่) -->
                        <div id="task7-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 7: จงหาความยาวของถนน $\vec{SP}$ (ตอบทศนิยม 1 ตำแหน่ง)</p>
                            <div class="mt-2 flex items-center gap-3">
                                <input type="number" id="t7-ans" class="game-input w-28" placeholder="ความยาว">
                                <button class="game-button" onclick="checkTask(7)">ตรวจสอบ</button>
                            </div>
                            <p id="feedback-t7" class="feedback"></p>
                        </div>

                        <!-- ภารกิจ 8 (ใหม่) -->
                        <div id="task8-card" class="task-card hidden"> <!-- [EDIT] เพิ่ม class hidden -->
                            <p class="font-semibold">ภารกิจ 8: สร้าง 'ตลาด' (M) ที่จุดกึ่งกลางถนนระหว่าง S และ P จงหาพิกัดของ M</p>
                            <div class="mt-2 flex items-center gap-3">
                                ( <input type="number" id="t8-x" class="game-input w-20" placeholder="X"> , 
                                <input type="number" id="t8-y" class="game-input w-20" placeholder="Y"> )
                                <button class="game-button" onclick="checkTask(8)">สร้าง</button>
                            </div>
                            <p id="feedback-t8" class="feedback"></p>
                        </div>
                        
                        <!-- ข้อความยินดี (ใหม่) -->
                        <p id="success-msg" class="hidden text-2xl font-bold text-center text-green-800 p-6 bg-gradient-to-r from-green-100 to-lime-100 border-2 border-green-300 rounded-lg shadow-lg items-center justify-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-party-popper"><path d="M19 6.5c0 .28-.03.55-.08.83a.9.9 0 0 1-.4.55l-4.04 3.1a.9.9 0 0 0-.4.55c-.05.28-.08.55-.08.83c0 .28.03.55.08.83a.9.9 0 0 0 .4.55l4.04 3.1a.9.9 0 0 1 .4.55c.05.28.08.55.08.83c0 1.38-1.12 2.5-2.5 2.5s-2.5-1.12-2.5-2.5c0-.28.03-.55.08-.83a.9.9 0 0 0 .4-.55l4.04-3.1a.9.9 0 0 1-.4-.55c-.05-.28-.08-.55-.08-.83c0-.28.03-.55.08-.83a.9.9 0 0 1 .4-.55l-4.04-3.1a.9.9 0 0 0-.4-.55c-.05-.28-.08-.55-.08-.83C14 5.12 15.12 4 16.5 4s2.5 1.12 2.5 2.5Z"/><path d="m5.8 11.3 1.8-1.8"/><path d="M11.2 5.7 9.4 4"/><path d="m5.8 4 1.8 1.8"/><path d="M4 11.3l1.8-1.8"/><path d="m11.2 18.2 1.8 1.8"/><path d="m5.8 20 1.8-1.8"/><path d="m4 12.7 1.8 1.8"/><path d="M9.4 20l1.8-1.8"/></svg>
                            ยินดีด้วย! คุณออกแบบเมืองเสร็จสมบูรณ์!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- การตั้งค่าทั่วไป ---
        let canvas, ctx;
        const scale = 20; // 20 pixels ต่อ 1 หน่วย
        let centerX, centerY;

        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            // [EDIT] อัปเดต centerX, centerY ตามขนาด canvas ใหม่ (700x500)
            centerX = canvas.width / 2; // 350
            centerY = canvas.height / 2; // 250
            drawGrid(ctx, canvas.width, canvas.height, centerX, centerY, scale);
            plotPoint(ctx, 0, 0, 'gray', 'O', centerX, centerY);
        });

        // --- ฟังก์ชันวาดแผนที่ (Grid) ---
        function drawGrid(ctx, w, h, centerX, centerY, gridScale) {
            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = '#cbd5e1'; // สีเส้นตาราง (Slate-300)
            ctx.lineWidth = 0.5;

            // วาดเส้นตารางแนวตั้ง
            for (let x = centerX + gridScale; x < w; x += gridScale) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, h);
                ctx.stroke();
            }
            for (let x = centerX - gridScale; x > 0; x -= gridScale) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, h);
                ctx.stroke();
            }
            // วาดเส้นตารางแนวนอน
            for (let y = centerY + gridScale; y < h; y += gridScale) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }
            for (let y = centerY - gridScale; y > 0; y -= gridScale) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }

            // วาดแกน X และ Y
            ctx.strokeStyle = '#64748b'; // สีแกน (Slate-500)
            ctx.lineWidth = 2;
            // แกน X
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(w, centerY);
            ctx.stroke();
            // แกน Y
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, h);
            ctx.stroke();
        }

        // --- ฟังก์ชันวาดจุดบนแผนที่ ---
        function plotPoint(ctx, x, y, color, label, targetCenterX, targetCenterY) {
            const drawX = targetCenterX + (x * scale);
            const drawY = targetCenterY - (y * scale); // แกน Y ของ canvas กลับด้าน

            // วาดจุด
            ctx.beginPath();
            ctx.arc(drawX, drawY, 6, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            
            // วาดป้ายชื่อ
            ctx.fillStyle = '#1f2937'; // gray-800
            ctx.font = 'bold 14px Sarabun';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'bottom';
            ctx.fillText(`${label} (${x}, ${y})`, drawX + 8, drawY - 8);
        }
        
        // --- ฟังก์ชันวาดเวกเตอร์ ---
        function drawVector(ctx, x1, y1, x2, y2, color, targetCenterX, targetCenterY) {
            const startX = targetCenterX + (x1 * scale);
            const startY = targetCenterY - (y1 * scale);
            const endX = targetCenterX + (x2 * scale);
            const endY = targetCenterY - (y2 * scale);
            
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2.5; // หนาขึ้นเล็กน้อย
            
            // วาดหัวลูกศร
            const headlen = 10;
            const angle = Math.atan2(endY - startY, endX - startX);
            ctx.lineTo(endX - headlen * Math.cos(angle - Math.PI / 6), endY - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - headlen * Math.cos(angle + Math.PI / 6), endY - headlen * Math.sin(angle + Math.PI / 6));
            
            ctx.stroke();
        }

        // --- ลอจิกเกม ---
        let gameState = {
            locations: {},
            tasksCompleted: 0
        };

        function checkTask(taskNum) {
            const feedbackEl = document.getElementById(`feedback-t${taskNum}`);
            const cardEl = document.getElementById(`task${taskNum}-card`);
            let isCorrect = false;
            let x, y, ans;
            
            // ตรวจสอบว่ามีจุดที่จำเป็นหรือยัง
            const H = gameState.locations['H'];
            const S = gameState.locations['S'];
            const P = gameState.locations['P'];

            try {
                switch (taskNum) {
                    case 1:
                        x = parseFloat(document.getElementById('t1-x').value);
                        y = parseFloat(document.getElementById('t1-y').value);
                        if (x === 1 && y === 2) {
                            isCorrect = true;
                            gameState.locations['H'] = {x: 1, y: 2};
                            plotPoint(ctx, 1, 2, '#3b82f6', 'H (ศาลากลาง)', centerX, centerY);
                        }
                        break;
                    case 2:
                        x = parseFloat(document.getElementById('t2-x').value);
                        y = parseFloat(document.getElementById('t2-y').value);
                        if (x === -3 && y === 5) {
                            isCorrect = true;
                            gameState.locations['S'] = {x: -3, y: 5};
                            plotPoint(ctx, -3, 5, '#10b981', 'S (โรงเรียน)', centerX, centerY);
                        }
                        break;
                    case 3: // พิกัด P (คำนวณจาก S + v)
                        if (!S) {
                            feedbackEl.textContent = 'ต้องสร้างโรงเรียน (ภารกิจ 2) ก่อน!';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        x = parseFloat(document.getElementById('t3-x').value);
                        y = parseFloat(document.getElementById('t3-y').value);
                        // P = S + v = (-3+7, 5+1) = (4, 6)
                        if (x === 4 && y === 6) {
                            isCorrect = true;
                            gameState.locations['P'] = {x: 4, y: 6};
                            plotPoint(ctx, 4, 6, '#ef4444', 'P (โรงพยาบาล)', centerX, centerY);
                        }
                        break;
                    case 4: // เวกเตอร์ HP
                        if (!H || !P) {
                            feedbackEl.textContent = 'ต้องสร้าง H และ P (ภารกิจ 1, 3) ก่อน!';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        x = parseFloat(document.getElementById('t4-x').value); // a
                        y = parseFloat(document.getElementById('t4-y').value); // b
                        // HP = P - H = (4-1, 6-2) = (3, 4)
                        if (x === 3 && y === 4) { 
                            isCorrect = true;
                            drawVector(ctx, 1, 2, 4, 6, '#a855f7', centerX, centerY); // วาดถนน HP (สีม่วง)
                        }
                        break;
                    case 5: // ความยาว |HP|
                         if (!H || !P) {
                            feedbackEl.textContent = 'ต้องสร้าง H และ P (ภารกิจ 1, 3) ก่อน!';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        ans = parseFloat(document.getElementById('t5-ans').value);
                        // |HP| = sqrt(3^2 + 4^2) = sqrt(9 + 16) = sqrt(25) = 5
                        if (ans === 5) {
                            isCorrect = true;
                        }
                        break;
                    case 6: // เวกเตอร์ SP
                        if (!S || !P) {
                            feedbackEl.textContent = 'ต้องสร้าง S และ P (ภารกิจ 2, 3) ก่อน!';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        x = parseFloat(document.getElementById('t6-x').value); // a
                        y = parseFloat(document.getElementById('t6-y').value); // b
                        // SP = P - S = (4 - (-3), 6 - 5) = (7, 1)
                        if (x === 7 && y === 1) { 
                            isCorrect = true;
                             drawVector(ctx, -3, 5, 4, 6, '#e11d48', centerX, centerY); // วาดถนน SP (สีชมพู)
                        }
                        break;
                    case 7: // ความยาว |SP|
                        if (!S || !P) {
                            feedbackEl.textContent = 'ต้องสร้าง S และ P (ภารกิจ 2, 3) ก่อน!';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        ans = parseFloat(document.getElementById('t7-ans').value);
                        // |SP| = sqrt(7^2 + 1^2) = sqrt(49 + 1) = sqrt(50) = 7.07...
                        if (ans === 7.1) {
                            isCorrect = true;
                        }
                        break;
                    case 8: // จุดกึ่งกลาง M
                        if (!S || !P) {
                            feedbackEl.textContent = 'ต้องสร้าง S และ P (ภารกิจ 2, 3) ก่อน!';
                            feedbackEl.className = 'feedback incorrect';
                            return;
                        }
                        x = parseFloat(document.getElementById('t8-x').value);
                        y = parseFloat(document.getElementById('t8-y').value);
                        // M = S + 0.5*SP = (-3, 5) + 0.5*(7, 1) = (-3, 5) + (3.5, 0.5) = (0.5, 5.5)
                        // หรือ M = (S+P)/2 = ((-3+4)/2, (5+6)/2) = (1/2, 11/2) = (0.5, 5.5)
                        if (x === 0.5 && y === 5.5) {
                            isCorrect = true;
                            gameState.locations['M'] = {x: 0.5, y: 5.5};
                            plotPoint(ctx, 0.5, 5.5, '#f97316', 'M (ตลาด)', centerX, centerY);
                        }
                        break;
                }
            } catch (e) {
                isCorrect = false;
            }
            
            if (isCorrect) {
                feedbackEl.textContent = 'ภารกิจสำเร็จ!';
                feedbackEl.className = 'feedback correct';

                // --- [NEW] Logic to show the next task ---
                // (ใช้ ?. (optional chaining) เพื่อป้องกัน error หาก element ไม่มี)
                switch (taskNum) {
                    case 1:
                        document.getElementById('task2-card')?.classList.remove('hidden');
                        break;
                    case 2:
                        document.getElementById('task3-card')?.classList.remove('hidden');
                        break;
                    case 3:
                        // จบเฟส 1, แสดงหัวข้อเฟส 2 และภารกิจ 4
                        document.getElementById('phase2-heading')?.classList.remove('hidden');
                        document.getElementById('phase2-desc')?.classList.remove('hidden');
                        document.getElementById('task4-card')?.classList.remove('hidden');
                        break;
                    case 4:
                        document.getElementById('task5-card')?.classList.remove('hidden');
                        break;
                    case 5:
                        document.getElementById('task6-card')?.classList.remove('hidden');
                        break;
                    case 6:
                        document.getElementById('task7-card')?.classList.remove('hidden');
                        break;
                    case 7:
                        document.getElementById('task8-card')?.classList.remove('hidden');
                        break;
                    case 8:
                        // ภารกิจสุดท้าย, ไม่ต้องแสดงอะไรเพิ่ม (ข้อความยินดีจะแสดงด้านล่าง)
                        break;
                }
                // --- [END NEW] ---

                if (!cardEl.classList.contains('completed')) {
                    cardEl.classList.add('completed');
                    gameState.tasksCompleted++;
                    
                    // --- อัปเดต Progress Bar ---
                    const totalTasks = 8;
                    const percentage = (gameState.tasksCompleted / totalTasks) * 100;
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = percentage + '%';
                    }
                    // --- จบการอัปเดต ---
                }
                
                // ตรวจสอบว่าจบเกมหรือยัง
                if (gameState.tasksCompleted === 8) { // อัปเดตจำนวนภารกิจทั้งหมด
                    const successMsg = document.getElementById('success-msg');
                    if(successMsg) {
                        successMsg.classList.remove('hidden');
                        successMsg.classList.add('flex'); // เพิ่ม flex เพื่อจัดไอคอน
                    }
                }
            } else {
                 if (feedbackEl.textContent === '') { // ป้องกันการเขียนทับ error message ที่เจาะจง
                    feedbackEl.textContent = 'ผิดพลาด! ลองอีกครั้ง';
                    feedbackEl.className = 'feedback incorrect';
                 }
            }
        }

    </script>
</body>
</html>
